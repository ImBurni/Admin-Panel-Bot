<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel ¬∑ Sicher</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: #2d2d2d;
            padding: 2rem;
            border-radius: 10px;
            width: 400px;
        }
        
        .admin-container {
            background: #2d2d2d;
            padding: 2rem;
            border-radius: 10px;
            width: 800px;
            max-width: 100%;
        }
        
        h2 {
            color: white;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            color: white;
            border-radius: 5px;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            font-size: 16px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .hidden {
            display: none !important;
        }
        
        .user-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr;
            padding: 12px;
            background: #3d3d3d;
            margin: 5px 0;
            color: white;
            border-radius: 5px;
            align-items: center;
        }
        
        .header-row {
            background: #4d4d4d;
            font-weight: bold;
        }
        
        .btn-approve {
            background: #28a745;
            padding: 6px 12px;
            width: auto;
            margin-right: 5px;
            font-size: 14px;
        }
        
        .btn-reject {
            background: #dc3545;
            padding: 6px 12px;
            width: auto;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #3d3d3d;
            padding: 15px;
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
            margin-top: 5px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }
        
        .logout-btn {
            background: #dc3545;
            width: auto;
            padding: 8px 20px;
        }
        
        .message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        
        .success {
            color: #28a745;
        }

        .admin-badge {
            background: #ff4d4d;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
    <!-- SHA256 Bibliothek -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginPage" class="container">
        <h2>üîê Admin Login</h2>
        <input type="text" id="username" placeholder="Benutzername">
        <input type="password" id="password" placeholder="Passwort">
        <button onclick="login()">Einloggen</button>
        <button onclick="showRegister()" style="background: #6c757d;">Registrieren</button>
        <div id="loginMessage" class="message"></div>
    </div>

    <!-- REGISTER -->
    <div id="registerPage" class="container hidden">
        <h2>üìù Registrieren</h2>
        <input type="text" id="regUsername" placeholder="Benutzername">
        <input type="password" id="regPassword" placeholder="Passwort">
        <button onclick="register()">Registrieren</button>
        <button onclick="backToLogin()" style="background: #6c757d;">Zur√ºck</button>
        <div id="registerMessage" class="message"></div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminPage" class="admin-container hidden">
        <div class="header">
            <h2>üë• Nutzerverwaltung <span id="userRole"></span></h2>
            <button class="logout-btn" onclick="logout()">Abmelden</button>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div>Gesamt</div>
                <div class="stat-number" id="totalStats">0</div>
            </div>
            <div class="stat-box">
                <div>Ausstehend</div>
                <div class="stat-number" id="pendingStats">0</div>
            </div>
            <div class="stat-box">
                <div>Aktiv</div>
                <div class="stat-number" id="activeStats">0</div>
            </div>
        </div>

        <div class="user-row header-row">
            <div>Benutzername</div>
            <div>Rolle</div>
            <div>Status</div>
            <div>Aktionen</div>
        </div>
        <div id="userList"></div>
    </div>

    <script>
        // ========== SICHERE VERSION MIT HASH ==========
        
        // WICHTIG: So wird der Admin-Hash EINMALIG generiert
        const ADMIN_HASH = CryptoJS.SHA256('admin123').toString();
        console.log('Admin Hash:', ADMIN_HASH); // Zum Pr√ºfen in Konsole (F12)
        
        // Datenbank initialisieren (nur 1x)
        if (!localStorage.getItem('secure_users')) {
            const initialUsers = [
                {
                    id: '1',
                    username: 'ImBurni',
                    passwordHash: ADMIN_HASH,  // Hier ist der Hash gespeichert!
                    role: 'Admin',
                    status: 'aktiv'
                }
            ];
            localStorage.setItem('secure_users', JSON.stringify(initialUsers));
            console.log('‚úÖ Admin wurde angelegt');
        }

        // ========== HILFSFUNKTIONEN ==========
        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        function getUsers() {
            return JSON.parse(localStorage.getItem('secure_users')) || [];
        }

        function saveUsers(users) {
            localStorage.setItem('secure_users', JSON.stringify(users));
        }

        // ========== LOGIN ==========
        window.login = function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const msgBox = document.getElementById('loginMessage');
            
            console.log('Login mit:', username);
            
            if (!username || !password) {
                msgBox.innerHTML = '‚ùå Bitte alles ausf√ºllen';
                return;
            }

            const users = getUsers();
            const passwordHash = hashPassword(password);
            
            console.log('Password Hash:', passwordHash);
            
            // User suchen
            const user = users.find(u => u.username === username);
            
            if (!user) {
                msgBox.innerHTML = '‚ùå Benutzer nicht gefunden';
                return;
            }
            
            console.log('Gespeicherter Hash:', user.passwordHash);
            console.log('Vergleich:', user.passwordHash === passwordHash ? '‚úÖ' : '‚ùå');
            
            if (user.passwordHash !== passwordHash) {
                msgBox.innerHTML = '‚ùå Falsches Passwort';
                return;
            }
            
            if (user.status !== 'aktiv') {
                msgBox.innerHTML = '‚è≥ Account noch nicht freigeschaltet';
                return;
            }
            
            // Erfolgreich eingeloggt
            currentUser = user;
            sessionStorage.setItem('currentUser', JSON.stringify({
                id: user.id,
                username: user.username,
                role: user.role
            }));
            
            // UI umschalten
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            document.getElementById('userRole').innerHTML = `(${user.role})`;
            
            loadUsers();
        };

        // ========== REGISTRIERUNG ==========
        window.register = function() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const msgBox = document.getElementById('registerMessage');
            
            if (!username || !password) {
                msgBox.innerHTML = '‚ùå Bitte alles ausf√ºllen';
                return;
            }
            
            if (password.length < 4) {
                msgBox.innerHTML = '‚ùå Passwort zu kurz (min. 4 Zeichen)';
                return;
            }
            
            const users = getUsers();
            
            // Pr√ºfen ob schon existiert
            if (users.find(u => u.username === username)) {
                msgBox.innerHTML = '‚ùå Benutzername bereits vergeben';
                return;
            }
            
            // Neuen User mit GEHASHTEM Passwort
            const newUser = {
                id: Date.now().toString(),
                username: username,
                passwordHash: hashPassword(password), // NUR der Hash wird gespeichert!
                role: 'Moderator',
                status: 'ausstehend'
            };
            
            users.push(newUser);
            saveUsers(users);
            
            msgBox.style.color = '#28a745';
            msgBox.innerHTML = '‚úÖ Registriert! Admin muss freischalten';
            
            // Felder leeren
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            
            setTimeout(backToLogin, 2000);
        };

        // ========== ADMIN FUNKTIONEN ==========
        window.approveUser = function(id) {
            let users = getUsers();
            users = users.map(u => {
                if (u.id == id) {
                    return {...u, status: 'aktiv'};
                }
                return u;
            });
            saveUsers(users);
            loadUsers();
        };

        window.rejectUser = function(id) {
            let users = getUsers();
            users = users.filter(u => u.id != id);
            saveUsers(users);
            loadUsers();
        };

        window.deleteUser = function(id) {
            let users = getUsers();
            users = users.filter(u => u.id != id);
            saveUsers(users);
            loadUsers();
        };

        function loadUsers() {
            const users = getUsers();
            const normalUsers = users.filter(u => u.username !== 'ImBurni');
            
            // Stats
            document.getElementById('totalStats').innerHTML = normalUsers.length;
            document.getElementById('pendingStats').innerHTML = normalUsers.filter(u => u.status === 'ausstehend').length;
            document.getElementById('activeStats').innerHTML = normalUsers.filter(u => u.status === 'aktiv').length;
            
            // User-Liste
            let html = '';
            normalUsers.forEach(user => {
                html += `
                    <div class="user-row">
                        <div>${user.username}</div>
                        <div>${user.role} ${user.role === 'Admin' ? '<span class="admin-badge">Admin</span>' : ''}</div>
                        <div style="color: ${user.status === 'aktiv' ? '#28a745' : '#ffc107'}">${user.status}</div>
                        <div>
                            ${user.status === 'ausstehend' ? `
                                <button class="btn-approve" onclick="approveUser('${user.id}')">‚úî Freischalten</button>
                                <button class="btn-reject" onclick="rejectUser('${user.id}')">‚úñ Ablehnen</button>
                            ` : `
                                <button class="btn-reject" onclick="deleteUser('${user.id}')">üóë Entfernen</button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            if (normalUsers.length === 0) {
                html = '<div style="color: white; text-align: center; padding: 20px;">üì≠ Keine registrierten Nutzer</div>';
            }
            
            document.getElementById('userList').innerHTML = html;
        }

        // ========== UI FUNKTIONEN ==========
        window.showRegister = function() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('registerPage').classList.remove('hidden');
        };

        window.backToLogin = function() {
            document.getElementById('registerPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        };

        window.logout = function() {
            sessionStorage.removeItem('currentUser');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        };

        // ========== SESSION CHECK ==========
        let currentUser = null;
        const savedUser = sessionStorage.getItem('currentUser');
        
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            if (currentUser.username === 'ImBurni') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('adminPage').classList.remove('hidden');
                document.getElementById('userRole').innerHTML = `(${currentUser.role})`;
                loadUsers();
            }
        }

        // Enter-Taste
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        console.log('‚úÖ Seite geladen');
        console.log('Admin: ImBurni / Passwort: admin123');
    </script>
</body>
</html>
